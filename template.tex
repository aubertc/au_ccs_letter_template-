\documentclass[paper=letter, font=10pt, oneside]{scrlttr2}

%%%%%%%%%%%%%%%%%%%% 
% Possible improvments:
% Add "Continue on the next page", cf. https://tex.stackexchange.com/q/236275/
% Using \usepackage[short]{turnthepage} would be nice, but the indication is in the footer,
% and I don't know how to move it. Cf. https://tex.stackexchange.com/q/239705/
%%%%%%%%%%%%%%%%%%%%% 

% Current issues:
% Center header and footer
% Check spacing / margins
% Make sure template still compile if options are not set.
% Personalise opening and closing

%%%%%%%%%%%%
% To debug %
%%%%%%%%%%%%

%\LoadLetterOption{visualize}
%\showfields{head,foot,refline,address,location,firsthead,firstfoot,nextfoot,firstfoothpos}
%\usepackage{showframe}

%%%%%%%%%%%%%
% Foldmarks %
%%%%%%%%%%%%%

\KOMAoptions{foldmarks=TBmpL}
\setplength{foldmarkhpos}{0cm}
\setplength{tfoldmarklength}{7mm}
\setplength{bfoldmarklength}{7mm}

%%%%%%%%%%%%%%%%%%
% Koma variables %
%%%%%%%%%%%%%%%%%%

\setkomavar{fromemail}{$email$}
\setkomavar{fromurl}{$website$}
\setkomavar{subject}{$subject$}
\setkomavar{fromname}{$author$}
\setkomavar{fromphone}{$phone$}

%%%%%%%%%%%%%%%
% Some layout %
%%%%%%%%%%%%%%%

\KOMAoptions{backaddress=false}       % We do not dispaly our address on top.
\KOMAoptions{subject=titled}          % We prefix "Subject:" to the subject.
\setplength{subjectbeforevskip}{-3em} % Smaller horizontal spacing before the subject
% We want the date *before* the recipient.
% cf. https://tex.stackexchange.com/a/616345
\KOMAoptions{refline=dateleft}
\setplength{refvpos}{\useplength{toaddrvpos}}
\addtoplength{refaftervskip}{\useplength{toaddrheight}}
% We align the date with the recipient's address.
\setplength{toaddrhpos}{7.7em} % Value found through trial-and-error.
% Ideally I would use refhpos but my current understanding is that this value is 0 until \opening is executed.

% If a mention is added.
$if(mention)$
\usepackage{draftwatermark}
\SetWatermarkText{$mention$}
\SetWatermarkScale{2.27}
\SetWatermarkColor{augustagrey!20}
$endif$

% If code is included.
$if(highlighting-macros)$
$highlighting-macros$
$endif$

% If attachments are included.
$if(attachment)$
\usepackage[xetex]{attachfile2}
$endif$

% That's an artifact from pandoc
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}
}

\usepackage{graphicx} % To include the logo and the signature
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}:
\makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
    \def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\usepackage{hyperref} % For hyperlinks
\usepackage{csquotes} % To quote properly

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Margins                                          %
% https://brand.augusta.edu/electronic-letterhead/ %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[
	vmargin={150bp, 150bp},
%	hmargin = 100bp,
%	headheight = 6in,
%	footskip = 80bp
    bottom=9em
]{geometry}
\setlength{\parskip}{1em} % Large skip between paragraphs
\setlength{\parindent}{0pt} % No indentations

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% Font                                           %
% https://brand.augusta.edu/typography/          %
% https://github.com/Fonthausen/CrimsonPro       %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\usepackage{fontspec} 
\setmainfont{CrimsonPro}[
	Path = CrimsonPro/ ,
	UprightFont = *-Regular ,
	BoldFont = *-SemiBold , % Or *-Bold A matter of taste, probably
	ItalicFont = *-Italic ,
	BoldItalicFont = *-SemiBoldItalic % Or *-BoldItalic A matter of taste, probably
]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% Header and footer                %
% https://brand.augusta.edu/logos/ %
% http://brand.augusta.edu/assets/ %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\usepackage{zref-lastpage}
\usepackage{tabularx} % For the table in the footer
\usepackage{multirow} % For the table in the footer

\pagestyle{headings}
%\renewcommand{\headrulewidth}{0pt} % Remove the line after the header

%% Header
\setkomavar{firsthead}{\usekomavar{fromlogo}}
\setplength{firstheadwidth}{103bp} % We adjust the size of the box to the width of the logo (rounded up)
\setplength{firstheadhpos}{\maxdimen} % This should center the first head. We center the first header
%\KOMAoptions{fromlogo=false}
\setkomavar{fromlogo}{\includegraphics[height=71bp]{logo/AugustaUniversity_S_CMYK.eps}} % Image format is 8820x6084, so that's ~103x71bp
% Logo is found from https://augustauniversity.app.box.com/s/hem28kpp3aj4so56p5f7a4abdpplxunl

%% Footer
% This is to compute the width of the table inside the footer.
\newplength{footercustom}
\setplength{footercustom}{\useplength{firstfootwidth}-3.2em} % Value found by trial-and-error

% This is the footer actual definition
\setkomavar{firstfoot}{%
	\textcolor{augustablue}{%
		\scriptsize
		\begin{tabularx}{\useplength{footercustom}}{*{3}X l}
			\multicolumn{4}{l}{\textbf{\large School of Computer and Cyber Sciences}}\\[.05in]
			\multicolumn{4}{l}{\enquote{\emph{A National Academic Center of Excellence in Cyber Defense Education designated by the National Security Agency/Department of Homeland Security.}}}
			\\[.05in] \hline \noalign{\vskip .1in}
			Mailing Address:								& Riverfront Campus Address: 		& Summerville Campus Address:\\
			1120 15\textsuperscript{th} Street, RV1-1600	& 100 Grace Hopper Lane, RV1-1600	& 2500 Walton Way, UH127		& %\multirow{3}{*}{
			\textbf{T 706-721-1110}%}
			\\	
			Augusta, GA 30912								& Augusta, GA  30901 				& Augusta, GA 30904				& \textbf{\href{https://augusta.edu/ccs}{augusta.edu/ccs}}
			\end{tabularx}
	}
}
% Standards for addresses:
% Postal Addressing Standards (PUB 28)
% https://pe.usps.com/text/pub28/welcome.htm
% https://pe.usps.com/cpim/ftp/pubs/Pub28/pub28.pdf

% Some magic for all the footers to be identical
\usepackage{scrlayer-scrpage}
\usepackage{xpatch}
\KOMAoptions{firstfoot=false}
\KOMAoptions{footwidth=page}
\setkomavar{nextfoot}{\usekomavar{firstfoot}}
%\ModifyLayer[
% addvoffset=-1ex
%]{plain.scrheadings.foot.above.line}% shift the footsepline up
\addtokomafont{pagefoot}{\normalfont}
\clearpairofpagestyles
\cfoot*{\usekomavar{firstfoot}}
\pagestyle{plain}
\xapptocmd\opening{\thispagestyle{plain}}{}{}% <- first pages will have pagestyle plain too

%\KOMAoptions{footheight=38pt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
% Colors                           %
% https://brand.augusta.edu/color/ %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\usepackage{xcolor}
\definecolor{augustablue}{HTML}{002f55}
\definecolor{augustagrey}{HTML}{A5ACAF}
\hypersetup{colorlinks, allcolors={augustablue}}

%%%%%%%%%%%%%%%%%%%%%%% 
% Opening and Closure %
%%%%%%%%%%%%%%%%%%%%%%% 

\renewcommand{\raggedsignature}{\raggedright} % We don't want the signature to be centered
\setkomavar{signature}{
    $if(signature)$
        \hbox{\hspace{1cm} \includegraphics[width=3em]{$signature$}}\\
    $endif$
    \vspace{1em}
    \textbf{$author$}$if(title)$, $title$$endif$\\
    $if(position)$
		$position$
	$endif$\\
    $if(phone)$
    t: $phone$\\
    $endif$
    $if(email)$
    \href{mailto:$email$}{$email$}\\
    $endif$
    $if(website)$
    \href{$website$}{$website$}
    $endif$
}

\hypersetup{
	pdfinfo={
		Title={Letter from $author$, Augusta University},
		$if(subject)$
		Subject={$subject$},
		$endif$
		Author={$author$},
	}
}


\begin{document}

    \begin{letter}%
	$if(recipient)$
	{$recipient$}
	$endif$
	
	\opening{$opening$}

	$body$
	
	$if(closing)$
	\closing{$closing$}
	$else$
	\closing{Sincerely,}
	$endif$
	
	$if(ps)$
	\ps
	PS: $ps$
	$endif$
   
    $if(cc)$
        \cc{
        $for(cc)$
            $cc$ \\ 
        $endfor$
        }
    $endif$
        
    $if(attachment)$
    \encl{
        $for(attachment)$
           \textattachfile[color=augustablue]{$attachment$}{$attachment$} \\ 
        $endfor$
        }
    $endif$
    \end{letter}
\end{document}
